# Title: v0.0.1-2-1-1 - Add User Details to Message Endpoint Response

## Summary: 
Enhance the GET /messages endpoint to include sender and receiver user details (full_name, role) using efficient database JOINs, eliminating the need for frontend to make additional API calls.

### Acceptance Criteria:
- [ ] GET /messages returns sender_name and sender_role for each message
- [ ] GET /messages returns receiver_name and receiver_role for each message
- [ ] Database query uses efficient JOINs (no N+1 query problem)
- [ ] Response schema updated to include new fields
- [ ] Query performance <200ms for 50 messages
- [ ] Backwards compatibility maintained
- [ ] Integration tests verify user details in response

### Test Strategy:

**Integration Tests (pytest):**
- Test message response includes sender user details
- Test message response includes receiver user details
- Test JOIN query performance with 100+ messages
- Test response schema validation
- Test query efficiency (single query with JOINs, not multiple queries)

**Tools:** pytest, pytest-asyncio, FastAPI TestClient, pytest-benchmark
**Coverage Target:** >85%

---

## üìù Code Changes

**Description:**
Enhance the message retrieval endpoint to JOIN with the users table twice (for sender and receiver) and include user details in the response.

**File:** `app/backend/schemas.py`

```diff
  class MessageResponseWithTask(MessageResponse):
      """Enhanced message response including task context"""
      task_title: Optional[str] = None
      task_status: Optional[TaskStatus] = None
+     sender_name: Optional[str] = None
+     sender_role: Optional[UserRole] = None
+     receiver_name: Optional[str] = None
+     receiver_role: Optional[UserRole] = None
      
      class Config:
          from_attributes = True
```

**File:** `app/backend/main.py`

```diff
  @app.get("/messages", response_model=List[schemas.MessageResponseWithTask])
  async def get_messages(
      current_user: User = Depends(get_current_user),
      db: Session = Depends(get_db)
  ):
+     # Create aliases for sender and receiver users
+     Sender = aliased(User)
+     Receiver = aliased(User)
+     
      messages = db.query(
          Message.id,
          Message.sender_id,
          Message.receiver_id,
          Message.task_id,
          Message.content,
          Message.read,
          Message.created_at,
          Task.title.label('task_title'),
-         Task.status.label('task_status')
+         Task.status.label('task_status'),
+         Sender.full_name.label('sender_name'),
+         Sender.role.label('sender_role'),
+         Receiver.full_name.label('receiver_name'),
+         Receiver.role.label('receiver_role')
      ).outerjoin(
          Task, Message.task_id == Task.id
+     ).join(
+         Sender, Message.sender_id == Sender.id
+     ).join(
+         Receiver, Message.receiver_id == Receiver.id
      ).filter(
          or_(
              Message.sender_id == current_user.id,
              Message.receiver_id == current_user.id
          )
      ).order_by(Message.created_at.desc()).all()
      
      return messages
```

---

## üì° API Specs (If Applicable)

```yaml
openapi: 3.0.0
paths:
  /messages:
    get:
      summary: Get all messages for current user with full context
      responses:
        '200':
          description: List of messages with user and task details
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    sender_id:
                      type: integer
                    sender_name:
                      type: string
                    sender_role:
                      type: string
                      enum: [customer, tasker]
                    receiver_id:
                      type: integer
                    receiver_name:
                      type: string
                    receiver_role:
                      type: string
                      enum: [customer, tasker]
                    task_id:
                      type: integer
                      nullable: true
                    task_title:
                      type: string
                      nullable: true
                    task_status:
                      type: string
                      nullable: true
                    content:
                      type: string
                    read:
                      type: boolean
                    created_at:
                      type: string
                      format: date-time
```

---

## Issue Dependencies

**Depends on:**
- v0.0.1-1-2-2 - Enhance Message Response with Task Details

**Blocks:**
- v0.0.1-2-1-2 - Update Messages Component to Display User Details (Frontend)

## Related Issues

- v0.0.1-2-1-2 - Update Messages Component to Display User Details
- v0.0.1-1-2-2 - Enhance Message Response with Task Details