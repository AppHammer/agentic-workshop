# Title: v0.0.1-2-4-1 - Implement Task-Filtered Message View

## Summary: 
Add task filtering dropdown to Messages component allowing users to filter conversations by specific task, helping users focus on messages related to particular tasks when managing multiple conversations.

### Acceptance Criteria:
- [ ] Task filter dropdown added to Messages component header
- [ ] Dropdown populated with all tasks user is involved with
- [ ] Tasks sorted by most recent activity
- [ ] "All Tasks" option to clear filter and show all conversations
- [ ] Filter updates conversation list in real-time (no page refresh)
- [ ] Empty state message when no conversations match selected task
- [ ] Filter state persists during component session
- [ ] Dropdown accessible via keyboard
- [ ] Screen reader compatible

### Test Strategy:

**Unit Tests (Jest/React Testing Library):**
- Test dropdown renders with user's tasks
- Test "All Tasks" option functionality
- Test filtering updates conversation list correctly
- Test empty state when no matches
- Test filter state persistence
- Test keyboard navigation
- Test accessibility

**Tools:** Jest, React Testing Library
**Coverage Target:** >85%

---

## ğŸ–¥ï¸ Front End Components (If Applicable)

**Component Name:** `Messages.js`

**Description:**
Add task filtering capability to help users manage conversations across multiple tasks.

**Code:**

```jsx
// app/frontend/src/components/Messages.js

const Messages = ({ user }) => {
  const [conversations, setConversations] = useState([]);
  const [filteredConversations, setFilteredConversations] = useState([]);
  const [selectedTaskFilter, setSelectedTaskFilter] = useState(null);
  const [userTasks, setUserTasks] = useState([]);
  
  useEffect(() => {
    loadMessages();
    loadUserTasks();
  }, []);
  
  useEffect(() => {
    // Apply filter whenever conversations or filter changes
    if (selectedTaskFilter === null) {
      setFilteredConversations(conversations);
    } else {
      const filtered = conversations.filter(conv =>
        conv.messages.some(msg => msg.task_id === selectedTaskFilter)
      );
      setFilteredConversations(filtered);
    }
  }, [conversations, selectedTaskFilter]);
  
  const loadUserTasks = async () => {
    try {
      // Get all tasks where user is involved (created, bid on, or has agreement)
      const tasks = await getUserTasks();
      setUserTasks(tasks);
    } catch (error) {
      console.error('Error loading tasks:', error);
    }
  };
  
  const handleTaskFilterChange = (e) => {
    const taskId = e.target.value ? parseInt(e.target.value) : null;
    setSelectedTaskFilter(taskId);
  };
  
  return (
    <div className="messages-container">
      <div className="conversations-panel">
        <div className="messages-header">
          <h2>Messages</h2>
          <div className="task-filter">
            <label htmlFor="task-filter">Filter by Task:</label>
            <select
              id="task-filter"
              value={selectedTaskFilter || ''}
              onChange={handleTaskFilterChange}
              className="task-filter-dropdown"
            >
              <option value="">All Tasks</option>
              {userTasks.map(task => (
                <option key={task.id} value={task.id}>
                  {task.title} ({task.status})
                </option>
              ))}
            </select>
          </div>
        </div>
        
        {filteredConversations.length === 0 ? (
          <p className="empty-state">
            {selectedTaskFilter 
              ? 'No conversations found for this task'
              : 'No messages yet'}
          </p>
        ) : (
          <div className="conversation-list">
            {filteredConversations.map(conv => (
              <div key={conv.partnerId} className="conversation-item">
                {/* Existing conversation rendering */}
              </div>
            ))}
          </div>
        )}
      </div>
      
      {/* Rest of Messages component */}
    </div>
  );
};
```

**File:** `app/frontend/src/api.js`

```diff
+ export const getUserTasks = async () => {
+   // Get tasks where user is customer, has bid, or has agreement
+   const response = await api.get('/tasks/my-tasks');
+   return response.data;
+ };
```

---

## ğŸ“¡ API Specs (If Applicable)

```yaml
openapi: 3.0.0
paths:
  /tasks/my-tasks:
    get:
      summary: Get all tasks user is involved with
      description: Returns tasks where user is creator, has bid, or has agreement
      responses:
        '200':
          description: List of user's tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    title:
                      type: string
                    status:
                      type: string
                    has_unread_messages:
                      type: boolean
```

---

## ğŸ“ Code Changes

**Description:**
Add backend endpoint to fetch user's tasks for filter dropdown.

**File:** `app/backend/main.py`

```python
@app.get("/tasks/my-tasks")
async def get_my_tasks(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Get all tasks where user is involved (creator, bidder, or has agreement)"""
    if current_user.role == UserRole.customer:
        # Get tasks created by customer
        tasks = db.query(Task).filter(
            Task.customer_id == current_user.id
        ).all()
    else:  # Tasker
        # Get tasks where tasker has bid, offer, or agreement
        tasks = db.query(Task).join(
            or_(
                Bid.task_id == Task.id and Bid.tasker_id == current_user.id,
                Offer.task_id == Task.id and Offer.tasker_id == current_user.id,
                Agreement.task_id == Task.id and Agreement.tasker_id == current_user.id
            )
        ).distinct().all()
    
    return tasks
```

---

## Issue Dependencies

**Depends on:**
- v0.0.1-1-2-2 - Enhance Message Response with Task Details
- v0.0.1-2-1-2 - Update Messages Component to Display User Details

## Related Issues

- v0.0.1-1-2-1 - Add Task Context to Message Creation
- v0.0.1-1-2-2 - Enhance Message Response with Task Details