# Title: v0.0.1-1-1-1 - Create Permission Validation Function

## Summary: 
Implement a reusable permission validation function that checks whether a user has permission to message another user based on their relationship through bids, offers, or agreements. This is the foundational security layer for the messaging system.

### Acceptance Criteria:
- [ ] Function `can_message_user()` implemented in backend (auth.py or new permissions.py module)
- [ ] Function checks all three relationship types: bids, offers, and agreements
- [ ] Returns True if any valid relationship exists, False otherwise
- [ ] Executes efficient database queries with proper JOINs
- [ ] Query performance < 100ms for validation check
- [ ] Handles edge cases: withdrawn bids, declined offers, completed agreements
- [ ] Function is reusable and can be called from any endpoint
- [ ] Comprehensive unit tests with >90% coverage

### Test Strategy:

**Unit Tests (pytest):**
- Test bid-based validation (customer â†” tasker with active bid)
- Test offer-based validation (customer â†” tasker with active offer)
- Test agreement-based validation (customer â†” tasker with agreement)
- Test rejection when no relationship exists
- Test edge cases: withdrawn bids, declined offers, multiple bids
- Test performance with database containing 100+ relationships

**Tools:** pytest, pytest-asyncio
**Coverage Target:** >90%

---

## ðŸ“ Code Changes

**Description:**
Create a new permission validation module that centralizes messaging authorization logic. The function will query the database for any existing relationship (bid, offer, or agreement) between two users.

**File:** `app/backend/permissions.py` (NEW FILE)

```python
from sqlalchemy.orm import Session
from sqlalchemy import or_, and_
from database import User, Task, Bid, Offer, Agreement
from schemas import UserRole

def can_message_user(db: Session, sender_id: int, receiver_id: int, sender_role: UserRole) -> bool:
    """
    Checks if sender has permission to message receiver based on task relationships.
    
    Args:
        db: Database session
        sender_id: User ID of message sender
        receiver_id: User ID of message receiver
        sender_role: Role of the sender (customer or tasker)
        
    Returns:
        True if messaging is allowed, False otherwise
    """
    
    # Check for active agreements (both directions)
    agreement = db.query(Agreement).join(Task).filter(
        or_(
            and_(Task.customer_id == sender_id, Agreement.tasker_id == receiver_id),
            and_(Task.customer_id == receiver_id, Agreement.tasker_id == sender_id)
        )
    ).first()
    
    if agreement:
        return True
    
    # Check for bids (tasker bid on customer's task, or vice versa)
    bid = db.query(Bid).join(Task).filter(
        or_(
            and_(Bid.tasker_id == sender_id, Task.customer_id == receiver_id),
            and_(Bid.tasker_id == receiver_id, Task.customer_id == sender_id)
        )
    ).first()
    
    if bid:
        return True
    
    # Check for offers (customer sent offer to tasker, or vice versa)
    offer = db.query(Offer).filter(
        or_(
            and_(Offer.customer_id == sender_id, Offer.tasker_id == receiver_id),
            and_(Offer.customer_id == receiver_id, Offer.tasker_id == sender_id)
        )
    ).first()
    
    if offer:
        return True
    
    return False
```

---

## âœ¨ New Files (If Applicable)

- `app/backend/permissions.py`
- `app/backend/test_permissions.py`

---

## ðŸ“¦ Dependencies (If Applicable)

**Package Manager:** `pip`

No new dependencies required - uses existing SQLAlchemy, FastAPI dependencies.

---

## Issue Dependencies

This issue must be completed before:
- v0.0.1-1-1-2 (Integrate Permission Validation)
- v0.0.1-3-1-1 (Bid-Based Messaging Integration)
- v0.0.1-3-2-1 (Offer-Based Messaging Integration)
- v0.0.1-3-3-1 (Agreement-Based Messaging Integration)

## Related Issues

- v0.0.1-1-1-2 - Integrate Permission Validation into Message Endpoint
- v0.0.1-1-1-3 - Add Permission Validation Unit Tests