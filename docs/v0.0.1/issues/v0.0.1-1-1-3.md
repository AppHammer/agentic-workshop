# Title: v0.0.1-1-1-3 - Add Comprehensive Unit Tests for Permission Validation

## Summary: 
Create comprehensive unit tests for the permission validation function covering all scenarios: bid-based, offer-based, agreement-based messaging, and edge cases like withdrawn bids and declined offers.

### Acceptance Criteria:
- [ ] Test suite covers all four validation scenarios (bid, offer, agreement, none)
- [ ] Test edge cases: withdrawn bids, declined offers, multiple bids from same tasker
- [ ] Test performance: validation completes in <100ms
- [ ] Test coverage >90% for permissions module
- [ ] Tests are isolated and use database fixtures
- [ ] All tests pass consistently
- [ ] Tests clearly document expected behavior

### Test Strategy:

**Unit Tests (pytest):**
- `test_can_message_with_active_bid()` - Customer can message tasker who bid
- `test_can_message_with_active_offer()` - Customer can message tasker they offered to
- `test_can_message_with_active_agreement()` - Both parties can message with agreement
- `test_cannot_message_without_relationship()` - Returns False when no relationship
- `test_cannot_message_after_bid_withdrawal()` - Edge case handled correctly
- `test_multiple_bids_same_tasker()` - Tasker with multiple bids can message
- `test_completed_agreement_messaging()` - Messaging allowed after completion
- `test_permission_validation_performance()` - Performance benchmark

**Tools:** pytest, pytest-asyncio, pytest-benchmark
**Coverage Target:** >90%

---

## âœ¨ New Files (If Applicable)

- `app/backend/test_permissions.py`

---

## ğŸ“ Code Changes

**Description:**
Create comprehensive test suite for the permission validation module. Tests will use database fixtures and cover all relationship types and edge cases.

**File:** `app/backend/test_permissions.py` (NEW FILE)

```python
import pytest
from sqlalchemy.orm import Session
from permissions import can_message_user
from database import User, Task, Bid, Offer, Agreement
from schemas import UserRole, TaskStatus

@pytest.fixture
def setup_test_data(db: Session):
    """Create test users, tasks, and relationships"""
    # Create users
    customer = User(id=1, email="customer@test.com", full_name="Test Customer", 
                   role=UserRole.customer, hashed_password="hash")
    tasker = User(id=2, email="tasker@test.com", full_name="Test Tasker",
                 role=UserRole.tasker, hashed_password="hash")
    other_tasker = User(id=3, email="other@test.com", full_name="Other Tasker",
                       role=UserRole.tasker, hashed_password="hash")
    
    db.add_all([customer, tasker, other_tasker])
    
    # Create task
    task = Task(id=1, customer_id=1, title="Test Task", 
               description="Test", status=TaskStatus.open)
    db.add(task)
    db.commit()
    
    return {"customer": customer, "tasker": tasker, "other_tasker": other_tasker, "task": task}

def test_can_message_with_active_bid(db, setup_test_data):
    """Customer can message tasker who placed bid on their task"""
    data = setup_test_data
    
    # Create bid
    bid = Bid(task_id=1, tasker_id=2, amount=50.0)
    db.add(bid)
    db.commit()
    
    # Test customer â†’ tasker
    assert can_message_user(db, 1, 2, UserRole.customer) == True
    
    # Test tasker â†’ customer
    assert can_message_user(db, 2, 1, UserRole.tasker) == True

def test_can_message_with_active_offer(db, setup_test_data):
    """Customer can message tasker they sent offer to"""
    data = setup_test_data
    
    # Create offer
    offer = Offer(task_id=1, customer_id=1, tasker_id=2, amount=45.0)
    db.add(offer)
    db.commit()
    
    # Test both directions
    assert can_message_user(db, 1, 2, UserRole.customer) == True
    assert can_message_user(db, 2, 1, UserRole.tasker) == True

def test_can_message_with_active_agreement(db, setup_test_data):
    """Both parties can message when agreement exists"""
    data = setup_test_data
    
    # Create agreement
    agreement = Agreement(task_id=1, tasker_id=2, amount=50.0, status="accepted")
    db.add(agreement)
    db.commit()
    
    # Test both directions
    assert can_message_user(db, 1, 2, UserRole.customer) == True
    assert can_message_user(db, 2, 1, UserRole.tasker) == True

def test_cannot_message_without_relationship(db, setup_test_data):
    """Returns False when no relationship exists"""
    data = setup_test_data
    
    # Test customer â†’ tasker with no bid/offer/agreement
    assert can_message_user(db, 1, 3, UserRole.customer) == False
    
    # Test tasker â†’ customer with no relationship
    assert can_message_user(db, 3, 1, UserRole.tasker) == False

def test_multiple_bids_same_tasker(db, setup_test_data):
    """Tasker with multiple bids on different tasks can message about any"""
    data = setup_test_data
    
    # Create second task
    task2 = Task(id=2, customer_id=1, title="Task 2", 
                description="Test", status=TaskStatus.open)
    db.add(task2)
    
    # Create bids on both tasks
    bid1 = Bid(task_id=1, tasker_id=2, amount=50.0)
    bid2 = Bid(task_id=2, tasker_id=2, amount=60.0)
    db.add_all([bid1, bid2])
    db.commit()
    
    # Should still be able to message
    assert can_message_user(db, 1, 2, UserRole.customer) == True

def test_completed_agreement_messaging(db, setup_test_data):
    """Messaging allowed even after agreement completion"""
    data = setup_test_data
    
    # Create completed agreement
    agreement = Agreement(task_id=1, tasker_id=2, amount=50.0, status="completed")
    db.add(agreement)
    db.commit()
    
    # Should still be able to message
    assert can_message_user(db, 1, 2, UserRole.customer) == True
    assert can_message_user(db, 2, 1, UserRole.tasker) == True

def test_permission_validation_performance(db, setup_test_data, benchmark):
    """Permission validation should complete in <100ms"""
    data = setup_test_data
    
    # Create bid for test
    bid = Bid(task_id=1, tasker_id=2, amount=50.0)
    db.add(bid)
    db.commit()
    
    # Benchmark the validation
    result = benchmark(can_message_user, db, 1, 2, UserRole.customer)
    assert result == True
```

---

## Issue Dependencies

**Depends on:**
- v0.0.1-1-1-1 - Create Permission Validation Function (MUST be completed first)

## Related Issues

- v0.0.1-1-1-1 - Create Permission Validation Function
- v0.0.1-1-1-2 - Integrate Permission Validation into Message Endpoint