# Title: v0.0.1-1-2-1 - Add Task Context to Message Creation

## Summary: 
Enhance the message creation endpoint to accept and validate task_id parameter, ensuring messages can be associated with specific tasks for better conversation context.

### Acceptance Criteria:
- [ ] POST /messages endpoint accepts optional task_id parameter
- [ ] Task validation: task_id must exist in database
- [ ] Task permission: sender must have permission to discuss that task
- [ ] Task_id properly stored in database with message
- [ ] Error handling for invalid task_id
- [ ] Integration tests verify task association
- [ ] Messages without task_id still supported (general messages)

### Test Strategy:

**Integration Tests (pytest):**
- Test message creation with valid task_id
- Test message creation without task_id (general message)
- Test message creation with invalid task_id (404 error)
- Test message creation where user doesn't have permission for task
- Test task_id association persists in database

**Tools:** pytest, pytest-asyncio, FastAPI TestClient
**Coverage Target:** >85%

---

## ğŸ“ Code Changes

**Description:**
Modify the POST /messages endpoint to validate and store task_id when provided. Ensure the task exists and the user has permission to message about it.

**File:** `app/backend/main.py`

```diff
  @app.post("/messages", response_model=schemas.MessageResponse)
  async def send_message(
      message: schemas.MessageCreate,
      current_user: User = Depends(get_current_user),
      db: Session = Depends(get_db)
  ):
      # Validate messaging permission
      has_permission = can_message_user(
          db=db,
          sender_id=current_user.id,
          receiver_id=message.receiver_id,
          sender_role=current_user.role
      )
      
      if not has_permission:
          raise HTTPException(
              status_code=403,
              detail="You do not have permission to message this user. "
                     "You can only message users with whom you have an active "
                     "bid, offer, or agreement relationship."
          )
+     
+     # Validate task_id if provided
+     if message.task_id is not None:
+         task = db.query(Task).filter(Task.id == message.task_id).first()
+         if not task:
+             raise HTTPException(
+                 status_code=404,
+                 detail=f"Task with id {message.task_id} not found"
+             )
+         
+         # Verify user has permission to discuss this task
+         # User must be task creator, have bid, have offer, or have agreement
+         if current_user.role == UserRole.customer:
+             if task.customer_id != current_user.id:
+                 raise HTTPException(
+                     status_code=403,
+                     detail="You do not have permission to discuss this task"
+                 )
+         else:  # Tasker
+             # Check for bid, offer, or agreement on this specific task
+             has_task_permission = (
+                 db.query(Bid).filter(
+                     Bid.task_id == message.task_id,
+                     Bid.tasker_id == current_user.id
+                 ).first() is not None or
+                 db.query(Offer).filter(
+                     Offer.task_id == message.task_id,
+                     Offer.tasker_id == current_user.id
+                 ).first() is not None or
+                 db.query(Agreement).filter(
+                     Agreement.task_id == message.task_id,
+                     Agreement.tasker_id == current_user.id
+                 ).first() is not None
+             )
+             if not has_task_permission:
+                 raise HTTPException(
+                     status_code=403,
+                     detail="You do not have permission to discuss this task"
+                 )
  
      db_message = Message(
          sender_id=current_user.id,
          receiver_id=message.receiver_id,
          task_id=message.task_id,
          content=message.content
      )
      db.add(db_message)
      db.commit()
      db.refresh(db_message)
      return db_message
```

---

## Issue Dependencies

**Depends on:**
- v0.0.1-1-1-2 - Integrate Permission Validation into Message Endpoint

**Blocks:**
- v0.0.1-1-2-2 - Enhance Message Response with Task Details
- v0.0.1-2-4-1 - Task-Filtered Message View (Frontend)

## Related Issues

- v0.0.1-1-2-2 - Enhance Message Response with Task Details
- v0.0.1-2-2-1 - Message Tasker Button Integration