# Title: v0.0.1-1-1-2 - Integrate Permission Validation into Message Endpoint

## Summary: 
Integrate the permission validation function into the POST /messages endpoint to enforce relationship-based messaging authorization. All message creation attempts will be validated before database insertion.

### Acceptance Criteria:
- [ ] Permission validation called in POST /messages endpoint before message creation
- [ ] 403 Forbidden response returned when permission check fails
- [ ] Clear error messages explain why permission was denied
- [ ] User ID extracted from JWT token (not request body) for security
- [ ] Validation occurs for all message creation paths
- [ ] Integration tests verify authorized and unauthorized scenarios
- [ ] Error responses include proper HTTP status codes and user-friendly messages

### Test Strategy:

**Integration Tests (pytest):**
- Test authorized message creation (bid relationship exists)
- Test unauthorized message creation (no relationship)
- Test 403 error response format and content
- Test user ID is taken from JWT, not request body
- Test all relationship types (bid, offer, agreement)

**Tools:** pytest, pytest-asyncio, FastAPI TestClient
**Coverage Target:** >90%

---

## ğŸ“ Code Changes

**Description:**
Modify the POST /messages endpoint in main.py to call the permission validation function before creating a message. Return appropriate errors when validation fails.

**File:** `app/backend/main.py`

```diff
+ from permissions import can_message_user

  @app.post("/messages", response_model=schemas.MessageResponse)
  async def send_message(
      message: schemas.MessageCreate,
      current_user: User = Depends(get_current_user),
      db: Session = Depends(get_db)
  ):
+     # Validate messaging permission
+     has_permission = can_message_user(
+         db=db,
+         sender_id=current_user.id,
+         receiver_id=message.receiver_id,
+         sender_role=current_user.role
+     )
+     
+     if not has_permission:
+         raise HTTPException(
+             status_code=403,
+             detail="You do not have permission to message this user. "
+                    "You can only message users with whom you have an active "
+                    "bid, offer, or agreement relationship."
+         )
  
      db_message = Message(
          sender_id=current_user.id,
          receiver_id=message.receiver_id,
          task_id=message.task_id,
          content=message.content
      )
      db.add(db_message)
      db.commit()
      db.refresh(db_message)
      return db_message
```

---

## ğŸ“¦ Dependencies (If Applicable)

**Package Manager:** `pip`

No new dependencies required.

---

## Issue Dependencies

**Depends on:**
- v0.0.1-1-1-1 - Create Permission Validation Function (MUST be completed first)

**Blocks:**
- v0.0.1-3-1-1 - Bid-Based Messaging Integration
- v0.0.1-3-2-1 - Offer-Based Messaging Integration
- v0.0.1-3-3-1 - Agreement-Based Messaging Integration

## Related Issues

- v0.0.1-1-1-1 - Create Permission Validation Function
- v0.0.1-1-1-3 - Add Permission Validation Unit Tests